<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>美股個股分析</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<style>
:root{--bg:#0b0e14;--card:#121826;--muted:#94a3b8;--text:#e2e8f0;--accent:#60a5fa;--ok:#22c55e;--warn:#f59e0b;--bad:#ef4444;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans',sans-serif;color:var(--text);padding-bottom:90px}
.wrap{max-width:1200px;margin:40px auto;padding:0 16px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
h1{font-size:28px;margin:0 0 12px}
label{display:block;margin:8px 0 6px;color:var(--muted)}
input,button,select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #334155;background:#0f172a;color:var(--text);font-size:16px}
input[type="date"]{-webkit-appearance:none;color:var(--text);}
input[type="date"]::-webkit-calendar-picker-indicator{filter:invert(1);}
option{background:#0f172a;color:var(--text);}
button{cursor:pointer;background:linear-gradient(135deg,#2563eb,#06b6d4);border:none}
button:disabled{opacity:.6;cursor:not-allowed}
.row{display:grid;grid-template-columns:repeat(3,1fr) 150px;gap:12px}
.muted{color:var(--muted)}
.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-top:12px}
.kpi{background:#0f172a;border:1px solid #1f2937;border-radius:12px;padding:12px}
.kpi h3{margin:0;font-size:13px;color:var(--muted)}
.kpi p{margin:6px 0 0;font-size:20px;font-weight:700}
pre{white-space:pre-wrap;word-break:break-word;background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:12px;color:#cbd5e1}
canvas{background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:10px}
.status-pill{margin-top:14px;display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;background:#0f172a;border:1px solid #1f2937;font-size:14px;color:var(--muted)}
.status-pill::before{content:'';width:10px;height:10px;border-radius:50%;background:var(--muted)}
.status-pill[data-state="running"]{color:#bfdbfe;border-color:#2563eb}
.status-pill[data-state="running"]::before{background:#60a5fa;animation:pulse 1s ease-in-out infinite}
.status-pill[data-state="done"]{color:var(--ok);border-color:var(--ok)}
.status-pill[data-state="done"]::before{background:var(--ok);animation:none}
.status-pill[data-state="error"]{color:var(--bad);border-color:var(--bad)}
.status-pill[data-state="error"]::before{background:var(--bad)}
.status-pill[data-state="idle"]::before{background:var(--muted)}
.status-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap;align-items:flex-start}
.ghost-btn{background:transparent;border:1px solid #334155;color:var(--muted);padding:8px 16px;border-radius:999px;font-size:14px;width:auto;display:inline-flex;align-items:center;justify-content:center;margin-top:2px}
#stop{display:none}
.ghost-btn:hover{border-color:#475569;color:#e2e8f0}
.batch-running{display:none;align-items:center;gap:8px;color:#bfdbfe;font-size:14px}
.batch-dot{width:12px;height:12px;border-radius:50%;background:#60a5fa;animation:pulse-ball .8s ease-in-out infinite}
.timeline{display:grid;gap:10px}
.ti{border:1px solid #1f2937;border-radius:12px;padding:12px;background:#0f172a}
.ti h4{margin:0 0 8px}
.ti .meta{font-size:13px;color:var(--muted)}
.summary{line-height:1.7}
@media(max-width:1000px){.grid,.row,.kpis{grid-template-columns:1fr}}
@keyframes pulse{0%{transform:scale(.7);opacity:.7}50%{transform:scale(1.3);opacity:1}100%{transform:scale(.7);opacity:.7}}
@keyframes pulse-ball{0%{transform:translateY(0)}50%{transform:translateY(-5px)}100%{transform:translateY(0)}}
</style>
</head>
<body>
<div class="wrap">
  <h1>美股個股分析</h1>
  <p class="muted">輸入股票代號與日期（後端固定使用 OpenAI gpt-4o-mini），系統會優先以 FMP 快取現價與歷史價，再結合 SEC 財報、分析師均價、GDELT 新聞情緒、動能/趨勢與體質評分，輸出 ChatGPT 總結、重大重點與批次報表。</p>
  <div class="card">
    <div class="row">
      <div><label>Ticker</label><input id="t" value="NVDA" placeholder="NVDA"/></div>
      <div><label>Date</label><input id="d" type="date" value="2025-11-08"/></div>
      <div style="align-self:end"><button id="go">分析</button></div>
      <div style="grid-column:1 / -1">
        <div class="status-row">
          <div id="status" class="status-pill" data-state="idle">待命中，請輸入條件後開始分析。</div>
          <button id="stop" class="ghost-btn">停止</button>
          <button id="refreshCache" class="ghost-btn" disabled>重新抓取</button>
        </div>
      </div>
    </div>
    <div class="kpis">
      <div class="kpi"><h3>現價</h3><p id="px">-</p></div>
      <div class="kpi"><h3>分析師平均/共識目標價</h3><p id="ptMean">-</p></div>
      <div class="kpi"><h3>ChatGPT 總結目標價</h3><p id="ptRange">-</p></div>
      <div class="kpi"><h3>建議</h3><p id="rating">-</p></div>
      <div class="kpi"><h3>類型</h3><p id="segment">-</p></div>
      <div class="kpi"><h3>個股體質分數</h3><p id="qualityScore">-</p></div>
      <div class="kpi"><h3>新聞情緒</h3><p id="newsSentiment">-</p></div>
      <div class="kpi"><h3>動能評分</h3><p id="momentumScore">-</p></div>
      <div class="kpi"><h3>趨勢走向</h3><p id="trendFlag">-</p></div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">ChatGPT 總結與結論</h3>
    <div id="consensus" class="summary muted">尚無資料</div>
    <div id="decision" class="summary" style="margin-top:8px"></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">財報時間線與重點摘要</h3>
    <div id="timeline" class="timeline"></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">個股體質詳解</h3>
    <div id="profileSummary" class="summary muted">尚無資料</div>
    <div id="profileDetail" class="summary" style="margin-top:8px"></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">動能與資金動向</h3>
    <div id="momentumSummary" class="summary muted">尚無動能資料</div>
    <div id="momentumDetail" class="summary" style="margin-top:8px"></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">新聞情緒與摘要</h3>
    <div id="newsSummary" class="summary muted">尚無新聞</div>
    <div id="newsArticles" class="summary" style="margin-top:8px"></div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">分析紀錄</h3>
    <div id="historyList" class="summary muted">尚無分析紀錄</div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">批次分析</h3>
    <div class="summary muted" style="margin-bottom:12px">
      利用下方工作列上傳 Excel/CSV（第一欄 ticker、第二欄 date，舊版第三欄 model 可留空），系統會逐行呼叫分析並下載包含現價、分析師平均/共識目標價、ChatGPT 目標價、建議、類型、體質分數、新聞情緒、動能分數與趨勢燈號的 CSV。
    </div>
    <div class="summary muted">
      <strong>步驟：</strong><br/>
      1. 按「選擇 Excel」並選取檔案。<br/>
      2. 上傳後工作列會變成跑動球並顯示「批次分析中」。<br/>
      3. 完成後自動觸發下載，並可在 JSON 區查看完整結果。
    </div>
    <div class="batch-card-action" style="margin-top:12px;display:flex;gap:12px;align-items:center">
      <input type="file" id="batchFile" accept=".xlsx,.xls,.csv" hidden>
      <button id="batchCardBtn">選擇 Excel</button>
      <div id="batchRunning" class="batch-running">
        <div class="batch-dot"></div>
        <span>批次分析中，請稍後…</span>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 style="margin:0 0 8px">詳細 JSON（除錯用）</h3>
    <pre id="out">尚未查詢</pre>
  </div>
</div>

<script>
function clamp(x){ return Math.max(0, Math.min(1, x)); }
function n(x, d=2){ const v=Number(x); return Number.isFinite(v)? v.toFixed(d):'-'; }
function toNum(x){ const v=Number(x); return Number.isFinite(v)? v:null; }

function ensureTargets(pt, current){
  let hi = toNum(pt?.targetHigh), lo = toNum(pt?.targetLow), mean = toNum(pt?.targetMean ?? pt?.targetMedian);
  const cur = toNum(current);
  if(mean!=null){
    if(hi==null) hi = mean * 1.15;
    if(lo==null) lo = mean * 0.85;
  }
  if(hi!=null && lo==null) lo = hi/1.2;
  if(lo!=null && hi==null) hi = lo*1.2;
  if(cur!=null){
    if(hi!=null && cur>hi) hi = cur*1.05;
    if(lo!=null && cur<lo) lo = cur*0.95;
  }
  return {hi, lo, mean, cur};
}

function formatNewsDate(raw){
  if(!raw) return '';
  let iso = raw;
  const match = /^([0-9]{4})([0-9]{2})([0-9]{2})T([0-9]{2})([0-9]{2})([0-9]{2})Z$/i.exec(raw);
  if(match){
    iso = `${match[1]}-${match[2]}-${match[3]}T${match[4]}:${match[5]}:${match[6]}Z`;
  }
  const parsed = dayjs(iso);
  return parsed.isValid() ? parsed.format('YYYY/MM/DD') : '';
}

function formatUsageLine(usage){
  if(!usage) return '';
  const prompt = usage.prompt_tokens ?? usage.promptTokens;
  const completion = usage.completion_tokens ?? usage.completionTokens;
  const totalCost = usage.total_cost ?? usage.totalCost;
  const tokensLabel = Number.isFinite(prompt) && Number.isFinite(completion)
    ? `${prompt}+${completion} tokens`
    : '';
  const costLabel = Number.isFinite(totalCost)
    ? `≈ $${Number(totalCost).toFixed(4)}`
    : '';
  const parts = [tokensLabel, costLabel].filter(Boolean).join(' ');
  return parts ? `<div class="muted" style="margin-top:6px">LLM 用量：${parts}</div>` : '';
}

function formatPriceMeta(meta){
  if(!meta?.value) return null;
  const map = {
    'fmp_quote':'即時價（FMP）',
    'fmp_historical':'歷史收盤（FMP）',
    'finnhub_candle':'歷史收盤（Finnhub）',
    'alphavantage_daily':'歷史收盤（AlphaVantage）',
    'yahoo_chart':'歷史收盤（Yahoo）',
    'yahoo_quote':'即時價（Yahoo）',
    'real-time':'即時價',
    'real-time_fallback':'即時價（備援）'
  };
  const label = map[meta.source] || (meta.kind === 'historical' ? '歷史收盤' : '即時價');
  const dateLabel = meta.as_of ? ` ${meta.as_of}` : '';
  return `${label}${dateLabel}`;
}

function formatPriceTargetSource(pt){
  if(!pt) return '';
  if(pt.source === 'unavailable' || pt.error){
    return '未取得';
  }
  const map = {
    'fmp':'FMP',
    'yahoo':'Yahoo Finance'
  };
  return map[pt.source] || (pt.source || '');
}

function formatSegment(profile){
  if(!profile) return '-';
  if(profile.segment_label) return profile.segment_label;
  const map = { large_cap:'大型股', small_cap:'小型股' };
  return map[profile.segment] || profile.segment || '-';
}

function formatScore(score){
  const num = toNum(score);
  return Number.isFinite(num) ? `${num.toFixed(0)}/100` : '-';
}

function formatPct(value){
  if(value==null || Number.isNaN(value)) return '-';
  return `${(value*100).toFixed(1)}%`;
}

function normalizeInputDate(raw){
  if(!raw) return '';
  const replaced = raw.replace(/\//g,'-');
  const direct = dayjs(replaced);
  if(direct.isValid()) return direct.format('YYYY-MM-DD');
  const alt = dayjs(new Date(raw));
  if(alt.isValid()) return alt.format('YYYY-MM-DD');
  return replaced;
}

function collectInputParams(){
  const tickerInput = document.getElementById('t');
  const dateInput = document.getElementById('d');
  const ticker = (tickerInput?.value || '').trim().toUpperCase();
  const rawDate = (dateInput?.value || '').trim();
  const normalizedDate = normalizeInputDate(rawDate);
  if(dateInput && rawDate && rawDate !== normalizedDate){
    dateInput.value = normalizedDate;
  }
  return { ticker, date: normalizedDate };
}

function setRefreshState(state){
  if(!refreshBtn) return;
  if(state === 'busy'){
    refreshBtn.disabled = true;
    refreshBtn.textContent = '重抓中...';
    return;
  }
  refreshBtn.textContent = refreshLabel;
  refreshBtn.disabled = state !== 'enabled';
}

function setKPIs(quote, pt, priceMeta, action, profile, news, momentum){
  const last = toNum(priceMeta?.value ?? quote?.c);
  const targets = ensureTargets(pt, last);
  const priceLabel = last? ('$'+last.toFixed(2)) : '-';
  const metaLabel = formatPriceMeta(priceMeta);
  document.getElementById('px').textContent = metaLabel ? `${priceLabel}（${metaLabel}）` : priceLabel;
  const ptSourceLabel = formatPriceTargetSource(pt);
  const ptMeanValue = targets.mean? ('$'+targets.mean.toFixed(2)) : '-';
  let ptMeanDisplay = ptMeanValue;
  if(ptSourceLabel === '未取得'){
    ptMeanDisplay = '未取得';
  }else if(ptSourceLabel){
    ptMeanDisplay = `${ptMeanValue}（${ptSourceLabel}）`;
  }
  document.getElementById('ptMean').textContent = ptMeanDisplay;
  const llmTarget = toNum(action?.target_price);
  document.getElementById('ptRange').textContent = llmTarget? ('$'+llmTarget.toFixed(0)) : '-';
  const ratingRaw = typeof action?.rating==='string' ? action.rating : '';
  const ratingMap = { BUY:'買進', HOLD:'觀望', SELL:'賣出' };
  const ratingKey = ratingRaw.toUpperCase();
  const ratingDisplay = ratingMap[ratingKey] || ratingRaw || '-';
  document.getElementById('rating').textContent = ratingDisplay;
  document.getElementById('segment').textContent = formatSegment(profile);
  document.getElementById('qualityScore').textContent = formatScore(profile?.score);
  newsSentimentEl.textContent = news?.sentiment?.sentiment_label || '-';
  momentumScoreEl.textContent = toNum(momentum?.score) != null ? Math.round(momentum.score) : '-';
  trendFlagEl.textContent = momentum?.trend || '-';
}

function renderTimeline(perFiling){
  const box = document.getElementById('timeline');
  box.innerHTML='';
  (perFiling||[]).forEach((f,i)=>{
    const exp = f.explanation || '（模型目前未提供詳細解釋）';
    const html = `
      <div class="ti">
        <h4>${f.formLabel || f.form || 'Filing'} · <span class="meta">${f.filingDate || ''}</span></h4>
        <div class="meta">報告期間：${f.reportDate || '-'}</div>
        <div class="summary" style="margin-top:6px">${exp}</div>
      </div>
    `;
    box.insertAdjacentHTML('beforeend', html);
  });
}

function renderConclusion(analysis, usageFallback){
  const cons = analysis?.consensus_view?.summary || '（尚無共識摘要）';
  const act = analysis?.action || {};
  const dec = (act.rating? `<b>${act.rating}</b>`:'-') +
              (act.target_price? ` · 目標價 $${n(act.target_price,0)}`:'') +
              (act.stop_loss? ` · 止損 $${n(act.stop_loss,0)}`:'');
  const usage = analysis?.__usage || usageFallback;
  const usageLine = formatUsageLine(usage);
  document.getElementById('consensus').innerHTML = usageLine ? `${cons}${usageLine}` : cons;
  document.getElementById('decision').innerHTML = dec + (act.rationale? `<div class="muted" style="margin-top:6px">${act.rationale}</div>`:'');
}

function renderMomentum(momentum){
  if(!momentum){
    momentumSummaryEl.textContent = '尚無動能資料';
    momentumDetailEl.textContent = '';
    return;
  }
  const scoreText = toNum(momentum.score)!=null ? `${Math.round(momentum.score)}` : '-';
  const trendText = momentum.trend || '中性';
  const ret3 = formatPct(momentum.returns?.m3);
  const ret6 = formatPct(momentum.returns?.m6);
  const ret12 = formatPct(momentum.returns?.m12);
  const rsi = momentum.rsi14!=null ? momentum.rsi14.toFixed(1) : '-';
  const atr = momentum.atr14!=null ? momentum.atr14.toFixed(2) : '-';
  const volRatio = momentum.volume_ratio!=null ? momentum.volume_ratio.toFixed(2) : '-';
  const etfLine = momentum.etf?.symbol ? `${momentum.etf.symbol} 3M ${formatPct(momentum.etf.return3m)}` : '－';
  const maNotes = [];
  if(momentum.moving_averages?.ma20) maNotes.push(`MA20 ${momentum.moving_averages.ma20.toFixed(2)}`);
  if(momentum.moving_averages?.ma50) maNotes.push(`MA50 ${momentum.moving_averages.ma50.toFixed(2)}`);
  if(momentum.moving_averages?.ma200) maNotes.push(`MA200 ${momentum.moving_averages.ma200.toFixed(2)}`);
  const maLine = maNotes.join(' ｜ ') || '均線資料不足';
  momentumSummaryEl.innerHTML = `<strong>${trendText}</strong> · 動能評分 ${scoreText} ｜ 3M ${ret3}`;
  momentumDetailEl.innerHTML = [
    `<div class="muted">6M ${ret6} ｜ 12M ${ret12}</div>`,
    `<div class="muted">RSI14 ${rsi} ｜ ATR14 ${atr} ｜ 量能比 (5/30) ${volRatio}</div>`,
    `<div class="muted">${maLine}</div>`,
    `<div class="muted">ETF 參考：${etfLine}</div>`
  ].join('<br/>');
}

function renderNews(bundle){
  if(!bundle){
    newsSummaryEl.textContent = '尚無新聞資料';
    newsArticlesEl.innerHTML = '';
    return;
  }
  const sentiment = bundle.sentiment || {};
  newsSummaryEl.innerHTML = `<strong>${sentiment.sentiment_label || '中性'}</strong> · ${sentiment.summary || '（尚無摘要）'}`;
  const events = Array.isArray(sentiment.supporting_events) ? sentiment.supporting_events : [];
  const articles = Array.isArray(bundle.articles) ? bundle.articles.slice(0,5) : [];
  const lines = [];
  if(events.length){
    lines.push('<div><strong>關鍵事件</strong></div>');
    events.forEach(ev=>{
      lines.push(`<div class="muted">• ${ev.title || '事件'}：${ev.reason || ''}</div>`);
    });
  }
  if(articles.length){
    lines.push('<div style="margin-top:8px"><strong>最新新聞</strong></div>');
    articles.forEach(a=>{
      const time = formatNewsDate(a.published_at);
      const title = a.title || '新聞';
      const url = a.url || '#';
      lines.push(`<div class="muted">• ${time} <a href="${url}" target="_blank" rel="noopener">${title}</a></div>`);
    });
  }
  newsArticlesEl.innerHTML = lines.join('') || '（尚無可用新聞）';
}

function renderHistory(){
  if(!analysisHistory.length){
    historyListEl.textContent = '尚無分析紀錄';
    return;
  }
  historyListEl.innerHTML = analysisHistory.map(item=>{
    return `<div style="margin-bottom:10px"><strong>${item.ticker}</strong> · ${item.date}<br/><span class="muted">${item.summary}</span></div>`;
  }).join('');
}

function renderProfile(profile){
  const summaryEl = document.getElementById('profileSummary');
  const detailEl = document.getElementById('profileDetail');
  if(!profile){
    summaryEl.textContent = '尚無資料';
    detailEl.textContent = '';
    return;
  }
  const filtersMet = profile.filters?.met ?? profile.filters_met;
  const filtersTotal = profile.filters?.total ?? profile.filters_total;
  const filterLine = (filtersMet!=null && filtersTotal!=null)
    ? `硬性條件：${filtersMet}/${filtersTotal} 項通過`
    : '';
  const scoreLine = Number.isFinite(toNum(profile.score))
    ? `體質評分：${formatScore(profile.score)}`
    : '';
  const segmentLine = formatSegment(profile);
  const headline = [segmentLine, filterLine, scoreLine].filter(Boolean).join(' ｜ ');
  const summaryText = profile.summary || profile.score_summary || profile.notes || '（模型尚未提供詳解）';
  summaryEl.innerHTML = `${headline? `<strong>${headline}</strong><br/>`:''}${summaryText}`;

  const details = [];
  const filterItems = profile.filters?.items || profile.filter_details;
  if(Array.isArray(filterItems) && filterItems.length){
    const list = filterItems.map(item=>{
      const passed = item.met ?? item.pass ?? false;
      const tag = passed ? '✅' : '⚠️';
      return `${tag} ${item.name || item.label || '條件'}：${item.reason || item.detail || ''}`;
    }).join('<br/>');
    details.push(`<div><strong>硬性過濾</strong><br/>${list}</div>`);
  }
  const scoreDetails = profile.score_detail || profile.score_breakdown;
  if(Array.isArray(scoreDetails) && scoreDetails.length){
    const list = scoreDetails.map(item=>{
      const pts = toNum(item.points ?? item.score);
      const ptsLabel = Number.isFinite(pts)? `${pts.toFixed(0)}分` : '';
      return `• ${(item.category || item.name || '').trim()} ${ptsLabel? `(${ptsLabel})`:''}：${item.reason || item.note || ''}`;
    }).join('<br/>');
    details.push(`<div style="margin-top:8px"><strong>打分拆解</strong><br/>${list}</div>`);
  }
  const catalysts = profile.catalysts;
  if(Array.isArray(catalysts) && catalysts.length){
    const list = catalysts.map(c=>`• ${c}`).join('<br/>');
    details.push(`<div style="margin-top:8px"><strong>催化重點</strong><br/>${list}</div>`);
  }
  detailEl.innerHTML = details.join('<br/><br/>');
}

const statusEl = document.getElementById('status');
const goBtn = document.getElementById('go');
const stopBtn = document.getElementById('stop');
const momentumScoreEl = document.getElementById('momentumScore');
const trendFlagEl = document.getElementById('trendFlag');
const momentumSummaryEl = document.getElementById('momentumSummary');
const momentumDetailEl = document.getElementById('momentumDetail');
const newsSentimentEl = document.getElementById('newsSentiment');
const newsSummaryEl = document.getElementById('newsSummary');
const newsArticlesEl = document.getElementById('newsArticles');
const historyListEl = document.getElementById('historyList');
const refreshBtn = document.getElementById('refreshCache');
const refreshLabel = refreshBtn?.textContent || '重新抓取';
const analyzeLabel = goBtn?.textContent || '分析';
let inFlightController = null;
let userAborted = false;
const analysisHistory = [];
let lastCompletedParams = null;

renderNews(null);
renderMomentum(null);
renderHistory();
setRefreshState('disabled');

function setStatus(text, state='idle'){
  statusEl.textContent = text;
  statusEl.setAttribute('data-state', state);
}

function setAnalyzeRunning(running){
  if(!goBtn) return;
  if(running){
    goBtn.disabled = true;
    goBtn.textContent = '分析中...';
    if(stopBtn){
      stopBtn.style.display = 'inline-flex';
      stopBtn.disabled = false;
    }
  }else{
    goBtn.disabled = false;
    goBtn.textContent = analyzeLabel;
    if(stopBtn){
      stopBtn.style.display = 'none';
      stopBtn.disabled = false;
    }
    inFlightController = null;
  }
  if(running){
    setRefreshState('disabled');
  }
}

async function analyze(){
  if(inFlightController){
    setStatus('已有分析任務執行中，請稍候或按「停止」。', 'running');
    return;
  }
  const { ticker, date } = collectInputParams();
  if(!ticker || !date){
    setStatus('請先輸入 Ticker 與 Date。', 'error');
    return;
  }

  userAborted = false;
  setAnalyzeRunning(true);
  setStatus(`正在分析 ${ticker}，這可能需要 1-2 分鐘，請勿關閉頁面…`, 'running');
  document.getElementById('out').textContent='分析中...';

  const controller = new AbortController();
  inFlightController = controller;

  try{
    const r = await fetch('/api/analyze',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ticker,date}),
      signal: controller.signal
    });
    const j = await r.json();
    document.getElementById('out').textContent = JSON.stringify(j,null,2);
    if(j.error){
      setStatus(`分析失敗：${j.error}`, 'error');
      return;
    }

    setKPIs(
      j?.fetched?.finnhub_summary?.quote,
      j?.fetched?.finnhub_summary?.price_target,
      j?.fetched?.finnhub_summary?.price_meta,
      j?.analysis?.action,
      j?.analysis?.profile,
      j?.news,
      j?.momentum
    );
    const filingsMeta = j?.fetched?.filings || [];
    const timelineData = (j?.analysis?.per_filing || []).map((f,i)=>{
      const meta = filingsMeta[i] || {};
      return {
        ...f,
        formLabel: f.formLabel || f.form_label || meta.form_label || meta.form || f.form
      };
    });
    renderTimeline(timelineData);
    renderConclusion(j?.analysis, j?.llm_usage);
    renderProfile(j?.analysis?.profile);
    renderNews(j?.news);
    renderMomentum(j?.momentum);
    const newsLabel = j?.news?.sentiment?.sentiment_label ? `新聞：${j.news.sentiment.sentiment_label}` : '';
    const momentumLabel = j?.momentum?.trend ? `動能：${j.momentum.trend}` : '';
    const baseSummary = j?.analysis?.consensus_view?.summary || j?.analysis?.action?.rationale || j?.news?.sentiment?.summary || '（尚無摘要）';
    const historySummary = [baseSummary, newsLabel, momentumLabel].filter(Boolean).join(' ｜ ');
    analysisHistory.unshift({
      ticker: j?.input?.ticker || ticker,
      date: j?.input?.date || date,
      summary: historySummary
    });
    if(analysisHistory.length > 10) analysisHistory.pop();
    renderHistory();
    setStatus('分析完成 ✅', 'done');
    lastCompletedParams = {
      ticker: j?.input?.ticker || ticker,
      date: j?.input?.date || date
    };
    setRefreshState('enabled');
  }catch(err){
    if(err.name === 'AbortError'){
      const msg = userAborted ? '用戶終止，請重新開始分析。' : '分析已中止，請稍後再試。';
      setStatus(msg, 'error');
      document.getElementById('out').textContent = '此次分析已被終止。';
    }else{
      setStatus(`連線失敗：${err.message}`, 'error');
    }
  }finally{
    setAnalyzeRunning(false);
    setRefreshState(lastCompletedParams ? 'enabled' : 'disabled');
  }
}

goBtn.addEventListener('click', analyze);
if(stopBtn){
  stopBtn.addEventListener('click', ()=>{
    if(!inFlightController) return;
    userAborted = true;
    stopBtn.disabled = true;
    inFlightController.abort();
  });
}

async function handleRefreshClick(){
  if(inFlightController){
    setStatus('分析進行中，請先等待完成或停止。', 'running');
    return;
  }
  if(!lastCompletedParams){
    setStatus('尚無可重抓的分析結果，請先完成一次分析。', 'error');
    return;
  }
  const { ticker, date } = collectInputParams();
  if(ticker !== lastCompletedParams.ticker || date !== lastCompletedParams.date){
    setStatus('目前輸入與最後一次分析不同，請先重新分析後再重抓。', 'error');
    return;
  }
  setRefreshState('busy');
  setStatus(`正在清除 ${ticker}（${date}）快取，請稍候…`, 'running');
  try{
    const resp = await fetch('/api/reset-cache',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ ticker, date })
    });
    const payload = await resp.json().catch(()=> ({}));
    if(!resp.ok || payload?.error){
      throw new Error(payload?.error || `HTTP ${resp.status}`);
    }
    setStatus('快取已清除，重新分析中…', 'running');
    await analyze();
  }catch(err){
    setStatus(`重新抓取失敗：${err.message}`, 'error');
    setRefreshState(lastCompletedParams ? 'enabled' : 'disabled');
  }
}

if(refreshBtn){
  refreshBtn.addEventListener('click', handleRefreshClick);
}

const batchFile = document.getElementById('batchFile');
const batchCardBtn = document.getElementById('batchCardBtn');
const batchRunning = document.getElementById('batchRunning');

function setBatchState(running){
  if(!batchCardBtn || !batchRunning) return;
  if(running){
    batchCardBtn.style.display = 'none';
    batchRunning.style.display = 'flex';
  }else{
    batchCardBtn.style.display = 'inline-flex';
    batchRunning.style.display = 'none';
  }
}
setBatchState(false);

async function handleBatchUpload(file){
  setBatchState(true);
  try{
    const fd = new FormData();
    fd.append('file', file);
    const res = await fetch('/api/batch',{ method:'POST', body: fd });
    if(!res.ok){
      const text = await res.text();
      throw new Error(text || '批次分析失敗');
    }
    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const base = file.name.replace(/\.[^.]+$/, '') || 'batch_results';
    const a = document.createElement('a');
    a.href = url;
    a.download = `${base}_results.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 2000);
  }catch(err){
    alert(`批次分析失敗：${err.message}`);
  }finally{
    setBatchState(false);
  }
}

if(batchCardBtn) batchCardBtn.addEventListener('click', ()=> batchFile.click());
batchFile.addEventListener('change', ()=>{
  const file = batchFile.files[0];
  if(file) handleBatchUpload(file);
  batchFile.value = '';
});
</script>
</body>
</html>
